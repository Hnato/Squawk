@page "/"
@page "/index.html"
@page "/Client/index.html"
@inject IJSRuntime JS

<div id="game-root">
    <canvas @ref="canvas"></canvas>
    <div class="hud">
        <div>Gracz: @(world?.Player?.Name ?? "—")</div>
        <div>Energia: @MathF.Round(world?.Player?.Energy ?? 0, 1)</div>
        <div>Rozmiar: @MathF.Round(world?.Player?.Size ?? 0, 1)</div>
        <div>Stan: @(world?.Player != null ? (world.Player.IsAlive ? "Żyje" : "Nie żyje") : "Brak")</div>
    </div>
    <div class="leaderboard">
        <div><strong>Ranking</strong></div>
        @if (world != null)
        {
            foreach (var e in world.Leaderboard())
            {
                <div>@e.Name: @MathF.Round(e.Energy,1)</div>
            }
        }
    </div>
    @if (world?.Player == null || !world.Player.IsAlive || !joined)
    {
        <div class="join-overlay">
            <div class="panel">
                <div style="font-weight:600;margin-bottom:8px;">Twoje imię papugi</div>
                <input @bind="playerName" placeholder="np. Ara" autofocus @onkeydown="HandleKey" />
                <button @onclick="Join">Start</button>
                <div class="hint">Papuga pojawi się min. 100 jednostek od innych. Po śmierci możesz dołączyć ponownie.</div>
            </div>
        </div>
    }
</div>

@code {
    ElementReference canvas;
    Squawk.Game.GameWorld? world;
    System.Diagnostics.Stopwatch sw = new();
    float lastTime;
    float hudAccum;
    bool initialized;
    bool joined;
    string playerName = "";
    System.Threading.CancellationTokenSource? cts;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!initialized)
        {
            initialized = true;
            await JS.InvokeVoidAsync("SquawkGame.init", canvas);
            world = new Squawk.Game.GameWorld();
            world.Initialize(botCount: 19);
            sw.Start();
            cts = new System.Threading.CancellationTokenSource();
            _ = Loop(cts.Token);
        }
    }

    class InputState
    {
        public float x { get; set; }
        public float y { get; set; }
        public bool down { get; set; }
        public bool space { get; set; }
        public float w { get; set; }
        public float h { get; set; }
    }

    async Task Loop(System.Threading.CancellationToken token)
    {
        const float tickRate = 64f;
        const float tickDt = 1f / tickRate;
        double acc = 0;
        while (!token.IsCancellationRequested)
        {
            var now = (float)sw.Elapsed.TotalSeconds;
            var dtFrame = MathF.Max(0f, now - lastTime);
            lastTime = now;
            acc += dtFrame;
            InputState input;
            if (JS is IJSInProcessRuntime jsSync)
                input = jsSync.Invoke<InputState>("SquawkGame.getInput");
            else
                input = await JS.InvokeAsync<InputState>("SquawkGame.getInput");
            var cam = CameraFor(world!.Player);
            var mouseWorld = new Vector2(
                cam.x + (input.x - input.w * 0.5f) / cam.zoom,
                cam.y + (input.y - input.h * 0.5f) / cam.zoom
            );
            var desired = world!.Player != null ? mouseWorld - world.Player.Position : Vector2.Zero;
            var boosting = (input.down || input.space) && world!.Player != null;
            var steps = (int)Math.Floor(acc / tickDt);
            steps = Math.Min(steps, 8);
            for (int i = 0; i < steps; i++)
            {
                await world.StepAsync(tickDt, desired, boosting);
            }
            acc -= steps * tickDt;
            if (world!.Player != null && !world.Player.IsAlive) joined = false;
            var payload = BuildPayload(cam);
            if (JS is IJSInProcessRuntime jsSyncDraw)
                jsSyncDraw.InvokeVoid("SquawkGame.draw", payload);
            else
                await JS.InvokeVoidAsync("SquawkGame.draw", payload);
            hudAccum += dtFrame;
            if (hudAccum > 0.2f)
            {
                hudAccum = 0f;
                StateHasChanged();
            }
            await Task.Delay(16, token);
        }
    }

    (float x, float y, float zoom) CameraFor(Squawk.Game.Parrot? p)
    {
        if (p == null) return (0f, 0f, 1f);
        var size = p.Size;
        var zoom = Math.Clamp(1.1f - size * 0.004f, 0.6f, 1.2f);
        return (p.Position.X, p.Position.Y, zoom);
    }

    object BuildPayload((float x, float y, float zoom) cam)
    {
        var bounds = world!.MapBounds;
        var feathers = world.Feathers.Select(f => new { x = f.Position.X, y = f.Position.Y, v = f.Value, t = f.Type == Squawk.Game.FeatherType.WorldFeather ? 0 : f.Type == Squawk.Game.FeatherType.BoostFeather ? 1 : 2 }).ToArray();
        var parrots = world.Parrots.Select(p => new
        {
            alive = p.IsAlive,
            hue = p.Hue,
            dirx = p.Direction.X,
            diry = p.Direction.Y,
            name = p.Name,
            segments = p.Segments.Select(s => new { x = s.Position.X, y = s.Position.Y, r = s.Radius }).ToArray()
        }).ToArray();
        return new
        {
            camera = new { x = cam.x, y = cam.y, zoom = cam.zoom },
            bounds = new { x = bounds.X, y = bounds.Y, w = bounds.W, h = bounds.H },
            feathers,
            parrots
        };
    }

    void Join()
    {
        if (world!.Player == null || !world.Player.IsAlive)
        {
            world.AddPlayer(playerName);
        }
        joined = true;
    }

    void HandleKey(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            Join();
        }
    }
}
